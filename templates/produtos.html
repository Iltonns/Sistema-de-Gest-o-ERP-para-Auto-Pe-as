{% extends "base.html" %}

{% block title %}Produtos - Sistema de Autope√ßas{% endblock %}
{% block page_title %}üîß Gerenciamento de Produtos{% endblock %}

{% block extra_css %}
<style>
    .product-card {
        border: 1px solid #e9ecef;
        transition: none;
    }
    
    .stock-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        background: white;
        color: #495057;
        border: 1px solid #dee2e6;
    }
    
    .category-icon {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa;
        color: #495057;
        font-size: 1.2rem;
        border: 1px solid #dee2e6;
    }
    
    .product-photo {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }
    
    .modal-product-photo {
        width: 200px;
        height: 200px;
        object-fit: cover;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        margin-bottom: 15px;
    }
    
    .photo-preview {
        max-width: 250px;
        max-height: 250px;
        margin-top: 15px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        display: none;
    }
    
    .photo-container {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 20px;
        text-align: center;
    }
    
    .table-header-professional {
        background: #1a237e !important;
        border-bottom: 2px solid #1a237e;
    }
    
    .table-header-professional th {
        color: white !important;
        font-weight: 600;
        font-size: 0.85rem;
        padding: 15px 12px;
        border: none !important;
        text-transform: none;
        letter-spacing: normal;
        background: #1a237e !important;
        display: table-cell !important;
        visibility: visible !important;
    }
    
    .professional-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        background: #f8f9fa;
        color: #495057;
        border: 1px solid #dee2e6;
        display: inline-block;
        white-space: nowrap;
    }
    
    /* Classes de status apenas com cores de texto */
    .status-disponivel {
        color: #28a745;
        font-weight: 600;
    }
    
    .status-baixo {
        color: #ffc107;
        font-weight: 600;
    }
    
    .status-indisponivel {
        color: #dc3545;
        font-weight: 600;
    }
    
    /* Bot√µes de a√ß√£o na tabela */
    .btn-group .btn {
        border-radius: 6px !important;
        margin: 0 1px;
        padding: 4px 8px;
        font-size: 0.8rem;
    }
    
    .btn-group .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .btn-add-product {
        background: #28a745;
        border: none;
        color: white;
        font-weight: 500;
    }
    
    .price-calculator {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin: 10px 0;
    }
    
    .form-control:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    /* Cards de Estat√≠sticas Melhorados */
    .stats-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stats-card .card-icon {
        width: 50px;
        height: 50px;
        margin: 0 auto 15px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 1.5rem;
    }
    
    .stats-card .card-number {
        font-size: 2rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .stats-card .card-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stats-card.primary .card-icon { background: #e3f2fd; color: #1976d2; }
    .stats-card.success .card-icon { background: #e8f5e8; color: #388e3c; }
    .stats-card.warning .card-icon { background: #fff3e0; color: #f57c00; }
    .stats-card.danger .card-icon { background: #ffebee; color: #d32f2f; }
    
    /* Cabe√ßalho da Tabela */
    .table-header-professional {
        background: #1a237e;
        border-bottom: 2px solid #1a237e;
    }
    
    .table-header-professional th {
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
        padding: 15px 12px;
        border: none;
        text-transform: none;
        letter-spacing: normal;
    }
    
    /* Remove efeitos desnecess√°rios */
    .product-card:hover,
    .product-photo:hover,
    .btn-add-product:hover {
        transform: none;
        box-shadow: none;
    }
    
    /* Tabela limpa */
    .table th, .table td {
        vertical-align: middle;
        border-top: 1px solid #dee2e6;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* Cabe√ßalho Principal */
    .page-header {
        background: #1a237e;
        color: white;
        padding: 20px 0;
        margin: -20px -15px 30px -15px;
        border-radius: 0;
    }
    
    .page-header h2 {
        margin: 0;
        font-weight: 600;
    }
    
    .page-header p {
        margin: 5px 0 0 0;
        opacity: 0.9;
    }
    
    /* Cards de Estat√≠sticas Menores */
    .stats-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 10px;
        text-align: center;
        margin-bottom: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stats-card .card-icon {
        width: 30px;
        height: 30px;
        margin: 0 auto 8px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 1rem;
    }
    
    .stats-card .card-number {
        font-size: 1.3rem;
        font-weight: 700;
        color: #495057;
        margin-bottom: 2px;
    }
    
    .stats-card .card-label {
        color: #6c757d;
        font-size: 0.7rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }
    
    .category-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-red) 100%);
        color: white;
        font-size: 1.2rem;
    }
    
    /* Tabela - Layout Corrigido */
    #tabelaProdutos {
        width: 100%;
        table-layout: fixed;
        border-collapse: collapse;
    }
    
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    #tabelaProdutos thead tr,
    #tabelaProdutos thead th {
        background: #1a237e !important;
        color: white !important;
        font-weight: 600;
        font-size: 0.85rem;
        padding: 12px 8px;
        border: none !important;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
    }
    
    /* Larguras espec√≠ficas das colunas */
    #tabelaProdutos th:nth-child(1) { width: 60px; }  /* Foto */
    #tabelaProdutos th:nth-child(2) { width: 50px; }  /* ID */
    #tabelaProdutos th:nth-child(3) { width: 220px; text-align: left; } /* Nome */
    #tabelaProdutos th:nth-child(4) { width: 100px; } /* Marca */
    #tabelaProdutos th:nth-child(5) { width: 120px; } /* Categoria */
    #tabelaProdutos th:nth-child(6) { width: 120px; } /* Pre√ßo */
    #tabelaProdutos th:nth-child(7) { width: 100px; } /* Estoque */
    #tabelaProdutos th:nth-child(8) { width: 120px; } /* C√≥digo */
    #tabelaProdutos th:nth-child(9) { width: 120px; } /* C√≥d. Fornecedor */
    #tabelaProdutos th:nth-child(10) { width: 100px; } /* Status */
    #tabelaProdutos th:nth-child(11) { width: 140px; } /* A√ß√µes */
    
    /* C√©lulas da tabela */
    #tabelaProdutos td {
        padding: 12px 8px;
        vertical-align: middle;
        border-bottom: 1px solid #dee2e6;
        font-size: 0.875rem;
        word-wrap: break-word;
        overflow: hidden;
    }
    
    /* Ajustes espec√≠ficos por coluna */
    #tabelaProdutos td:nth-child(1) { text-align: center; } /* Foto */
    #tabelaProdutos td:nth-child(2) { text-align: center; } /* ID */
    #tabelaProdutos td:nth-child(3) { text-align: left; }   /* Nome */
    #tabelaProdutos td:nth-child(4) { text-align: center; } /* Marca */
    #tabelaProdutos td:nth-child(5) { text-align: center; } /* Categoria */
    #tabelaProdutos td:nth-child(6) { text-align: right; }  /* Pre√ßo */
    #tabelaProdutos td:nth-child(7) { text-align: center; } /* Estoque */
    #tabelaProdutos td:nth-child(8) { text-align: center; } /* C√≥digo */
    #tabelaProdutos td:nth-child(9) { text-align: center; } /* C√≥d. Fornecedor */
    #tabelaProdutos td:nth-child(10) { text-align: center; } /* Status */
    #tabelaProdutos td:nth-child(11) { text-align: center; } /* A√ß√µes */
    
    /* Hover nas linhas */
    #tabelaProdutos tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .btn-add-product {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }
    
    .btn-add-product:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }
    
    .product-photo {
        width: 45px;
        height: 45px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .product-photo:hover {
        transform: scale(1.05);
        border-color: #1a237e;
    }
    
    .modal-product-photo {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 8px;
        border: 2px solid #e9ecef;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        margin-bottom: 15px;
    }
    
    .photo-preview {
        max-width: 250px;
        max-height: 250px;
        margin-top: 15px;
        border-radius: 12px;
        border: 2px solid #dee2e6;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: none;
    }
    
    .photo-container {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .photo-container:hover {
        border-color: var(--accent-orange);
        background: #fff3e0;
    }
    
    .professional-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 2px solid transparent;
    }
    
    .marca-badge {
        background: linear-gradient(135deg, #6f42c1 0%, #8e44ad 100%);
        color: white;
        border-color: #6f42c1;
    }
    
    .price-calculator {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
    }
    
    .form-control:focus {
        border-color: var(--accent-orange);
        box-shadow: 0 0 0 0.2rem rgba(255, 152, 0, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabe√ßalho Principal -->
    <div class="page-header">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-8">
                    <h2>
                        <i class="fas fa-cogs me-2"></i>
                        Cat√°logo de Produtos
                    </h2>
                    <p>Gerenciamento de Estoque de Auto Pe√ßas</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group" role="group">
                        <button class="btn btn-success btn-add-product" data-bs-toggle="modal" data-bs-target="#modalAdicionarProduto">
                            <i class="fas fa-plus me-2"></i>Adicionar Produto
                        </button>
                        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalImportarXML">
                            <i class="fas fa-file-import me-2"></i>Importar XML
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros e Busca -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nome, marca, c√≥digo, categoria...">
            </div>
        </div>
        <div class="col-md-3">
            <select id="categoriaFilter" class="form-select">
                <option value="">Todas as categorias</option>
                <option value="Motor">Motor</option>
                <option value="Freios">Freios</option>
                <option value="Suspens√£o">Suspens√£o</option>
                <option value="El√©trica">El√©trica</option>
                <option value="Transmiss√£o">Transmiss√£o</option>
                <option value="Carroceria">Carroceria</option>
                <option value="Filtros">Filtros</option>
                <option value="√ìleos">√ìleos</option>
            </select>
        </div>
        <div class="col-md-3">
            <select id="statusFilter" class="form-select">
                <option value="">Todos os status</option>
                <option value="disponivel">Dispon√≠vel</option>
                <option value="estoque_baixo">Estoque Baixo</option>
                <option value="indisponivel">Indispon√≠vel</option>
            </select>
        </div>
    </div>

    <!-- Controles de Pagina√ß√£o -->
    <div id="controlesPaginacaoProdutos"></div>

    <!-- Estat√≠sticas R√°pidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card primary">
                <div class="card-icon">
                    <i class="fas fa-boxes"></i>
                </div>
                <div class="card-number" id="totalProdutos">{{ produtos|length }}</div>
                <div class="card-label">Total de Produtos</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card success">
                <div class="card-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="card-number" id="produtosAtivos">
                    {{ produtos|selectattr('ativo')|list|length }}
                </div>
                <div class="card-label">Produtos Ativos</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card warning">
                <div class="card-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="card-number" id="estoqueBaixo">
                    {{ produtos|selectattr('estoque', 'lt', produtos[0].estoque_minimo if produtos else 5)|list|length }}
                </div>
                <div class="card-label">Estoque Baixo</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card danger">
                <div class="card-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="card-number" id="semEstoque">
                    {{ produtos|selectattr('estoque', 'eq', 0)|list|length }}
                </div>
                <div class="card-label">Sem Estoque</div>
            </div>
        </div>
    </div>

    <!-- Tabela de Produtos -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="tabelaProdutos">
                    <thead class="table-header-professional">
                        <tr>
                            <th>Foto</th>
                            <th>ID</th>
                            <th>Nome do Produto</th>
                            <th>Marca</th>
                            <th>Categoria</th>
                            <th>Pre√ßo</th>
                            <th>Estoque</th>
                            <th>C√≥digo</th>
                            <th>C√≥d. Fornecedor</th>
                            <th>Status</th>
                            <th width="140">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for produto in produtos %}
                        {% if produto.ativo %}
                        <tr>
                            <td>
                                {% if produto.foto_url %}
                                    <img src="{{ produto.foto_url }}" alt="Foto do produto" class="product-photo" 
                                         data-bs-toggle="tooltip" title="Clique para ampliar">
                                {% else %}
                                    <div class="product-photo d-flex align-items-center justify-content-center bg-light">
                                        <i class="fas fa-image text-muted"></i>
                                    </div>
                                {% endif %}
                            </td>
                            <td>
                                #{{ produto.id }}
                            </td>
                            <td>
                                <div>
                                    <span>{{ produto.nome }}</span>
                                    {% if produto.descricao %}
                                        <br><small class="text-muted">{{ produto.descricao[:50] }}{% if produto.descricao|length > 50 %}...{% endif %}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if produto.marca %}
                                    {{ produto.marca }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if produto.categoria %}
                                    {{ produto.categoria }}
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="text-success">R$ {{ "%.2f"|format(produto.preco) }}</div>
                                {% if produto.preco_custo and produto.preco_custo > 0 %}
                                    <small class="text-muted">Custo: R$ {{ "%.2f"|format(produto.preco_custo) }}</small>
                                    {% if produto.margem_lucro %}
                                        <br><small class="text-muted">Margem: {{ "%.1f"|format(produto.margem_lucro) }}%</small>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {{ produto.estoque }}
                                {% if produto.estoque <= produto.estoque_minimo and produto.estoque > 0 %}
                                    <i class="fas fa-exclamation-triangle text-warning ms-1"></i>
                                {% elif produto.estoque == 0 %}
                                    <i class="fas fa-times text-danger ms-1"></i>
                                {% endif %}
                                <br><small class="text-muted">M√≠n: {{ produto.estoque_minimo }}</small>
                            </td>
                            <td>
                                {% if produto.codigo_barras %}
                                    <small class="font-monospace">{{ produto.codigo_barras }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if produto.codigo_fornecedor %}
                                    <small class="font-monospace">{{ produto.codigo_fornecedor }}</small>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if produto.estoque > produto.estoque_minimo %}
                                    <span class="status-disponivel">Dispon√≠vel</span>
                                {% elif produto.estoque > 0 %}
                                    <span class="status-baixo">Estoque Baixo</span>
                                {% else %}
                                    <span class="status-indisponivel">Indispon√≠vel</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="editarProduto({{ produto.id }})" 
                                            title="Editar Produto"
                                            data-bs-toggle="tooltip">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-info" 
                                            onclick="visualizarProduto({{ produto.id }})" 
                                            title="Visualizar Detalhes"
                                            data-bs-toggle="tooltip">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="confirmarExclusao({{ produto.id }}, '{{ produto.nome }}')" 
                                            title="Excluir Produto"
                                            data-bs-toggle="tooltip">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Produto -->
<div class="modal fade" id="modalAdicionarProduto" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background-color: #1a237e;">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Adicionar Novo Produto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('adicionar_produto_route') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <!-- Informa√ß√µes B√°sicas -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-info-circle me-2"></i>Informa√ß√µes B√°sicas
                            </h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Nome do Produto *</label>
                                <input type="text" class="form-control" name="nome" required>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Categoria</label>
                                        <select class="form-select" name="categoria">
                                            <option value="">Selecione...</option>
                                            <option value="Motor">Motor</option>
                                            <option value="Freios">Freios</option>
                                            <option value="Suspens√£o">Suspens√£o</option>
                                            <option value="El√©trica">El√©trica</option>
                                            <option value="Transmiss√£o">Transmiss√£o</option>
                                            <option value="Carroceria">Carroceria</option>
                                            <option value="Filtros">Filtros</option>
                                            <option value="√ìleos">√ìleos</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Marca</label>
                                        <input type="text" class="form-control" name="marca">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Descri√ß√£o</label>
                                <textarea class="form-control" name="descricao" rows="3"></textarea>
                            </div>
                        </div>
                        
                        <!-- C√≥digos e Estoque -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-barcode me-2"></i>C√≥digos e Estoque
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">C√≥digo de Barras</label>
                                        <input type="text" class="form-control" name="codigo_barras">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">C√≥digo Fornecedor</label>
                                        <input type="text" class="form-control" name="codigo_fornecedor">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Estoque Atual</label>
                                        <input type="number" class="form-control" name="estoque" value="0" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Estoque M√≠nimo</label>
                                        <input type="number" class="form-control" name="estoque_minimo" value="5" min="1">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-camera me-2"></i>Foto do Produto
                                </label>
                                <div class="photo-container">
                                    <div class="text-center">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <p class="text-muted mb-2">Clique para selecionar uma foto</p>
                                        <input type="file" class="form-control" name="foto_produto" accept="image/*" onchange="previewImage(this, 'preview-add')">
                                        <small class="text-muted">Formatos aceitos: PNG, JPG, JPEG, GIF (m√°x. 5MB)</small>
                                    </div>
                                    <div class="text-center mt-3">
                                        <img id="preview-add" class="photo-preview">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calculadora de Pre√ßos -->
                    <div class="price-calculator">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-calculator me-2"></i>Calculadora de Pre√ßos
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Pre√ßo de Custo (R$)</label>
                                    <input type="number" class="form-control" name="preco_custo" step="0.01" min="0" id="preco_custo_add" oninput="calcularPreco('add')">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Margem de Lucro (%)</label>
                                    <input type="number" class="form-control" name="margem_lucro" step="0.01" min="0" id="margem_lucro_add" oninput="calcularPreco('add')">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Pre√ßo de Venda (R$) *</label>
                                    <input type="number" class="form-control" name="preco" step="0.01" min="0.01" id="preco_venda_add" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Salvar Produto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Produto -->
<div class="modal fade" id="modalEditarProduto" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background-color: #1a237e;">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Editar Produto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formEditarProduto" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <!-- Informa√ß√µes B√°sicas -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-info-circle me-2"></i>Informa√ß√µes B√°sicas
                            </h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Nome do Produto *</label>
                                <input type="text" class="form-control" name="nome" id="edit_nome" required>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Categoria</label>
                                        <select class="form-select" name="categoria" id="edit_categoria">
                                            <option value="">Selecione...</option>
                                            <option value="Motor">Motor</option>
                                            <option value="Freios">Freios</option>
                                            <option value="Suspens√£o">Suspens√£o</option>
                                            <option value="El√©trica">El√©trica</option>
                                            <option value="Transmiss√£o">Transmiss√£o</option>
                                            <option value="Carroceria">Carroceria</option>
                                            <option value="Filtros">Filtros</option>
                                            <option value="√ìleos">√ìleos</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Marca</label>
                                        <input type="text" class="form-control" name="marca" id="edit_marca">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Descri√ß√£o</label>
                                <textarea class="form-control" name="descricao" rows="3" id="edit_descricao"></textarea>
                            </div>
                        </div>
                        
                        <!-- C√≥digos e Estoque -->
                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-barcode me-2"></i>C√≥digos e Estoque
                            </h6>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">C√≥digo de Barras</label>
                                        <input type="text" class="form-control" name="codigo_barras" id="edit_codigo_barras">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">C√≥digo Fornecedor</label>
                                        <input type="text" class="form-control" name="codigo_fornecedor" id="edit_codigo_fornecedor">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Estoque Atual</label>
                                        <input type="number" class="form-control" name="estoque" id="edit_estoque" min="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Estoque M√≠nimo</label>
                                        <input type="number" class="form-control" name="estoque_minimo" id="edit_estoque_minimo" min="1">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-camera me-2"></i>Foto do Produto
                                </label>
                                <div class="photo-container">
                                    <div id="current_photo_container" style="display: none;">
                                        <div class="text-center mb-3">
                                            <img id="current_photo" class="modal-product-photo">
                                            <div class="mt-2">
                                                <span class="badge bg-success">Foto atual do produto</span>
                                            </div>
                                        </div>
                                        <div class="form-check text-center">
                                            <input class="form-check-input" type="checkbox" name="remover_foto" value="1" id="remover_foto">
                                            <label class="form-check-label text-danger" for="remover_foto">
                                                <i class="fas fa-trash me-1"></i>Remover foto atual
                                            </label>
                                        </div>
                                        <hr>
                                    </div>
                                    <div class="text-center">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                        <p class="text-muted mb-2">Clique para selecionar uma nova foto</p>
                                        <input type="file" class="form-control" name="foto_produto" accept="image/*" onchange="previewImage(this, 'preview-edit')">
                                        <small class="text-muted">Formatos aceitos: PNG, JPG, JPEG, GIF (m√°x. 5MB)</small>
                                    </div>
                                    <div class="text-center mt-3">
                                        <img id="preview-edit" class="photo-preview">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calculadora de Pre√ßos -->
                    <div class="price-calculator">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-calculator me-2"></i>Calculadora de Pre√ßos
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Pre√ßo de Custo (R$)</label>
                                    <input type="number" class="form-control" name="preco_custo" step="0.01" min="0" id="preco_custo_edit" oninput="calcularPreco('edit')">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Margem de Lucro (%)</label>
                                    <input type="number" class="form-control" name="margem_lucro" step="0.01" min="0" id="margem_lucro_edit" oninput="calcularPreco('edit')">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Pre√ßo de Venda (R$) *</label>
                                    <input type="number" class="form-control" name="preco" step="0.01" min="0.01" id="preco_venda_edit" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salvar Altera√ß√µes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Importar XML -->
<div class="modal fade" id="modalImportarXML" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header text-white" style="background-color: #1a237e;">
                <h5 class="modal-title">
                    <i class="fas fa-file-import me-2"></i>Importar Produtos via XML de NFe
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('importar_produtos_xml') }}" method="POST" enctype="multipart/form-data" id="formImportarXML">
                <div class="modal-body">
                    <!-- Instru√ß√£o -->
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Como funciona:</strong> Selecione um arquivo XML de NFe para importar automaticamente os produtos contidos na nota fiscal. 
                        O sistema extrair√° informa√ß√µes como c√≥digo, nome, c√≥digo de barras, NCM e pre√ßos dos produtos.
                    </div>

                    <!-- Upload do arquivo -->
                    <div class="row">
                        <div class="col-md-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-file-alt me-2"></i>Arquivo XML
                            </h6>
                            
                            <div class="mb-3">
                                <label class="form-label">Selecionar arquivo XML de NFe *</label>
                                <input type="file" class="form-control" name="arquivo_xml" accept=".xml" required>
                                <small class="text-muted">Formato aceito: Arquivo XML de NFe (.xml)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Configura√ß√µes de Importa√ß√£o -->
                    <div class="row">
                        <div class="col-md-12">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-cog me-2"></i>Configura√ß√µes de Importa√ß√£o
                            </h6>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Margem de Lucro Padr√£o (%)</label>
                                <input type="number" class="form-control" name="margem_padrao" value="100" step="0.01" min="0">
                                <small class="text-muted">Margem aplicada sobre o pre√ßo da NFe para calcular pre√ßo de venda</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Estoque M√≠nimo Padr√£o</label>
                                <input type="number" class="form-control" name="estoque_minimo_padrao" value="5" min="0">
                                <small class="text-muted">Quantidade m√≠nima de estoque para novos produtos</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="usar_preco_nfe" checked id="usar_preco_nfe">
                                    <label class="form-check-label" for="usar_preco_nfe">
                                        Usar pre√ßo da NFe como base
                                    </label>
                                </div>
                                <small class="text-muted">Se marcado, usar√° o pre√ßo unit√°rio da NFe como pre√ßo de custo</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">A√ß√£o para produtos existentes</label>
                                <select class="form-select" name="acao_existente">
                                    <option value="atualizar_estoque">Somar ao estoque atual</option>
                                    <option value="sobrescrever">Sobrescrever dados</option>
                                    <option value="ignorar">Ignorar produto</option>
                                </select>
                                <small class="text-muted">Como tratar produtos que j√° existem no sistema</small>
                            </div>
                        </div>
                    </div>

                    <!-- Exemplo de produtos que ser√£o importados -->
                    <div class="alert alert-light">
                        <h6 class="mb-2"><i class="fas fa-list me-2"></i>Exemplo de dados que ser√£o extra√≠dos:</h6>
                        <ul class="mb-0 small">
                            <li><strong>C√≥digo do produto:</strong> Campo cProd</li>
                            <li><strong>Nome:</strong> Campo xProd</li>
                            <li><strong>C√≥digo de barras:</strong> Campo cEAN/cEANTrib</li>
                            <li><strong>NCM:</strong> Campo NCM</li>
                            <li><strong>Unidade:</strong> Campo uCom</li>
                            <li><strong>Quantidade:</strong> Campo qCom</li>
                            <li><strong>Pre√ßo unit√°rio:</strong> Campo vUnCom</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-info" id="btnImportar">
                        <i class="fas fa-file-import me-2"></i>Importar Produtos
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Sistema de filtros antigo - desabilitado em favor da pagina√ß√£o
/*
document.getElementById('searchInput').addEventListener('input', function() {
    filtrarTabela();
});

document.getElementById('categoriaFilter').addEventListener('change', function() {
    filtrarTabela();
});

document.getElementById('statusFilter').addEventListener('change', function() {
    filtrarTabela();
});

function filtrarTabela() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoriaFilter = document.getElementById('categoriaFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#tabelaProdutos tbody tr');
    
    rows.forEach(row => {
        const nome = row.cells[2].textContent.toLowerCase();
        const marca = row.cells[3].textContent.toLowerCase();
        const categoria = row.cells[4].textContent.toLowerCase();
        const codigo = row.cells[7].textContent.toLowerCase();
        const status = row.cells[9].textContent.toLowerCase(); // Corrigido: coluna Status √© √≠ndice 9
        
        let showRow = true;
        
        // Filtro de busca (busca em nome, marca, categoria e c√≥digo)
        if (searchTerm && !nome.includes(searchTerm) && !marca.includes(searchTerm) && !categoria.includes(searchTerm) && !codigo.includes(searchTerm)) {
            showRow = false;
        }
        
        // Filtro de categoria
        if (categoriaFilter && !categoria.includes(categoriaFilter.toLowerCase())) {
            showRow = false;
        }
        
        // Filtro de status
        if (statusFilter) {
            const statusSpan = row.cells[9].querySelector('span'); // Corrigido: coluna Status √© √≠ndice 9
            const statusClass = statusSpan ? statusSpan.className : '';
            
            let matchesFilter = false;
            if (statusFilter === 'disponivel' && statusClass.includes('status-disponivel')) {
                matchesFilter = true;
            } else if (statusFilter === 'estoque_baixo' && statusClass.includes('status-baixo')) {
                matchesFilter = true;
            } else if (statusFilter === 'indisponivel' && statusClass.includes('status-indisponivel')) {
                matchesFilter = true;
            }
            
            if (!matchesFilter) showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
    });
}
*/

// Calculadora de pre√ßos
function calcularPreco(tipo) {
    const custo = parseFloat(document.getElementById(`preco_custo_${tipo}`).value) || 0;
    const margem = parseFloat(document.getElementById(`margem_lucro_${tipo}`).value) || 0;
    
    if (custo > 0 && margem >= 0) {
        const precoVenda = custo + (custo * margem / 100);
        document.getElementById(`preco_venda_${tipo}`).value = precoVenda.toFixed(2);
    }
}

// Preview de imagem
function previewImage(input, previewId) {
    const file = input.files[0];
    const preview = document.getElementById(previewId);
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
    } else {
        preview.style.display = 'none';
    }
}

// Visualizar produto (modal de detalhes)
function visualizarProduto(id) {
    fetch(`/api/produto/${id}`)
        .then(response => response.json())
        .then(produto => {
            if (produto.error) {
                alert('Produto n√£o encontrado!');
                return;
            }
            
            // Criar modal de visualiza√ß√£o dinamicamente
            const modalHtml = `
                <div class="modal fade" id="modalVisualizarProduto" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header text-white" style="background-color: #1a237e;">
                                <h5 class="modal-title">
                                    <i class="fas fa-eye me-2"></i>Detalhes do Produto #${produto.id}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-4 text-center">
                                        ${produto.foto_url ? 
                                            `<img src="${produto.foto_url}" class="img-fluid rounded shadow" style="max-height: 300px;">` :
                                            `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 200px;">
                                                <i class="fas fa-image fa-4x text-muted"></i>
                                            </div>`
                                        }
                                    </div>
                                    <div class="col-md-8">
                                        <h4 class="text-primary">${produto.nome}</h4>
                                        ${produto.marca ? `<p class="text-muted mb-2"><strong>Marca:</strong> ${produto.marca}</p>` : ''}
                                        ${produto.categoria ? `<p class="text-muted mb-2"><strong>Categoria:</strong> ${produto.categoria}</p>` : ''}
                                        ${produto.descricao ? `<p class="text-muted mb-3"><strong>Descri√ß√£o:</strong> ${produto.descricao}</p>` : ''}
                                        
                                        <div class="row">
                                            <div class="col-6">
                                                <div class="card bg-success text-white">
                                                    <div class="card-body text-center">
                                                        <h5>R$ ${produto.preco ? produto.preco.toFixed(2) : '0.00'}</h5>
                                                        <small>Pre√ßo de Venda</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="card ${produto.estoque > produto.estoque_minimo ? 'bg-info' : (produto.estoque > 0 ? 'bg-warning' : 'bg-danger')} text-white">
                                                    <div class="card-body text-center">
                                                        <h5>${produto.estoque || 0}</h5>
                                                        <small>Em Estoque</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-3">
                                            ${produto.codigo_barras ? `<p><strong>C√≥digo de Barras:</strong> <span class="font-monospace">${produto.codigo_barras}</span></p>` : ''}
                                            ${produto.codigo_fornecedor ? `<p><strong>C√≥digo do Fornecedor:</strong> <span class="font-monospace">${produto.codigo_fornecedor}</span></p>` : ''}
                                            ${produto.preco_custo ? `<p><strong>Pre√ßo de Custo:</strong> R$ ${produto.preco_custo.toFixed(2)}</p>` : ''}
                                            ${produto.margem_lucro ? `<p><strong>Margem de Lucro:</strong> ${produto.margem_lucro.toFixed(1)}%</p>` : ''}
                                            <p><strong>Estoque M√≠nimo:</strong> ${produto.estoque_minimo || 5}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" onclick="editarProduto(${produto.id})" data-bs-dismiss="modal">
                                    <i class="fas fa-edit me-2"></i>Editar Produto
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove modal existente se houver
            const existingModal = document.getElementById('modalVisualizarProduto');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Adiciona o novo modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Abre o modal
            new bootstrap.Modal(document.getElementById('modalVisualizarProduto')).show();
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar dados do produto!');
        });
}

// Editar produto
function editarProduto(id) {
    fetch(`/api/produto/${id}`)
        .then(response => response.json())
        .then(produto => {
            if (produto.error) {
                alert('Produto n√£o encontrado!');
                return;
            }
            
            // Preencher formul√°rio
            document.getElementById('edit_nome').value = produto.nome || '';
            document.getElementById('edit_categoria').value = produto.categoria || '';
            document.getElementById('edit_marca').value = produto.marca || '';
            document.getElementById('edit_descricao').value = produto.descricao || '';
            document.getElementById('edit_codigo_barras').value = produto.codigo_barras || '';
            document.getElementById('edit_codigo_fornecedor').value = produto.codigo_fornecedor || '';
            document.getElementById('edit_estoque').value = produto.estoque || 0;
            document.getElementById('edit_estoque_minimo').value = produto.estoque_minimo || 5;
            document.getElementById('preco_custo_edit').value = produto.preco_custo || '';
            document.getElementById('margem_lucro_edit').value = produto.margem_lucro || '';
            document.getElementById('preco_venda_edit').value = produto.preco || '';
            
            // Configurar foto atual
            const currentPhotoContainer = document.getElementById('current_photo_container');
            const currentPhoto = document.getElementById('current_photo');
            
            if (produto.foto_url) {
                currentPhoto.src = produto.foto_url;
                currentPhotoContainer.style.display = 'block';
            } else {
                currentPhotoContainer.style.display = 'none';
            }
            
            // Configurar action do formul√°rio
            document.getElementById('formEditarProduto').action = `/produtos/editar/${id}`;
            
            // Abrir modal
            new bootstrap.Modal(document.getElementById('modalEditarProduto')).show();
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao carregar dados do produto!');
        });
}

// Confirmar exclus√£o
function confirmarExclusao(id, nome) {
    if (confirm(`Tem certeza que deseja excluir o produto "${nome}"?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/produtos/deletar/${id}`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Limpar modals ao fechar
document.getElementById('modalAdicionarProduto').addEventListener('hidden.bs.modal', function() {
    this.querySelector('form').reset();
    document.getElementById('preview-add').style.display = 'none';
});

document.getElementById('modalEditarProduto').addEventListener('hidden.bs.modal', function() {
    this.querySelector('form').reset();
    document.getElementById('preview-edit').style.display = 'none';
    document.getElementById('remover_foto').checked = false;
});

// Inicializar tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    // Adicionar efeito de clique nas fotos para ampliar
    document.querySelectorAll('.product-photo').forEach(function(img) {
        if (img.src && img.src !== '') {
            img.style.cursor = 'pointer';
            img.addEventListener('click', function() {
                const modalHtml = `
                    <div class="modal fade" id="modalAmpliiarFoto" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header text-white" style="background-color: #1a237e;">
                                    <h5 class="modal-title">Foto do Produto</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <img src="${this.src}" class="img-fluid rounded">
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('modalAmpliiarFoto');
                if (existingModal) existingModal.remove();
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                new bootstrap.Modal(document.getElementById('modalAmpliiarFoto')).show();
            });
        }
    });
});

// JavaScript para o modal de importa√ß√£o XML
document.getElementById('formImportarXML').addEventListener('submit', function(e) {
    const btnImportar = document.getElementById('btnImportar');
    const arquivoInput = document.querySelector('input[name="arquivo_xml"]');
    
    // Verificar se arquivo foi selecionado
    if (!arquivoInput.files.length) {
        e.preventDefault();
        alert('Por favor, selecione um arquivo XML antes de importar.');
        return false;
    }
    
    // Verificar extens√£o do arquivo
    const fileName = arquivoInput.files[0].name.toLowerCase();
    if (!fileName.endsWith('.xml')) {
        e.preventDefault();
        alert('Por favor, selecione apenas arquivos XML (.xml).');
        return false;
    }
    
    // Mostrar indicador de carregamento
    btnImportar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processando...';
    btnImportar.disabled = true;
    
    // Mostrar alerta de processamento
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-warning mt-3';
    alertDiv.innerHTML = '<i class="fas fa-hourglass-half me-2"></i><strong>Processando arquivo XML...</strong> Isso pode levar alguns segundos dependendo do tamanho do arquivo.';
    
    const modalBody = document.querySelector('#modalImportarXML .modal-body');
    modalBody.appendChild(alertDiv);
});

// Resetar o modal quando fechado
document.getElementById('modalImportarXML').addEventListener('hidden.bs.modal', function() {
    const form = document.getElementById('formImportarXML');
    const btnImportar = document.getElementById('btnImportar');
    
    // Resetar formul√°rio
    form.reset();
    
    // Resetar bot√£o
    btnImportar.innerHTML = '<i class="fas fa-file-import me-2"></i>Importar Produtos';
    btnImportar.disabled = false;
    
    // Remover alertas de processamento
    const alerts = document.querySelectorAll('#modalImportarXML .alert-warning');
    alerts.forEach(alert => alert.remove());
});

// Valida√ß√£o em tempo real do arquivo
document.querySelector('input[name="arquivo_xml"]').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const feedback = document.querySelector('.file-feedback') || document.createElement('small');
    
    if (!feedback.classList.contains('file-feedback')) {
        feedback.className = 'file-feedback text-muted d-block mt-1';
        e.target.parentNode.appendChild(feedback);
    }
    
    if (file) {
        if (file.name.toLowerCase().endsWith('.xml')) {
            feedback.innerHTML = `<i class="fas fa-check text-success me-1"></i>Arquivo selecionado: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            feedback.className = 'file-feedback text-success d-block mt-1';
        } else {
            feedback.innerHTML = `<i class="fas fa-exclamation-triangle text-danger me-1"></i>Arquivo deve ser um XML (.xml)`;
            feedback.className = 'file-feedback text-danger d-block mt-1';
        }
    } else {
        feedback.remove();
    }
});

// Inicializa√ß√£o da Pagina√ß√£o de Produtos
document.addEventListener('DOMContentLoaded', function() {
    // Criar controles de pagina√ß√£o
    createPaginationControls('controlesPaginacaoProdutos', {
        searchId: 'buscaProdutos',
        itemsPerPageId: 'itensPorPaginaProdutos',
        visibleCountId: 'itensVisiveisProdutos',
        totalCountId: 'totalItensProdutos',
        prevBtnId: 'btnAnteriorProdutos',
        nextBtnId: 'btnProximoProdutos',
        paginationControlsId: 'controlesNavegacaoProdutos',
        pageInfoId: 'infoPaginacaoProdutos',
        searchPlaceholder: 'Buscar produtos por nome, marca, c√≥digo, categoria...'
    });

    // Verificar se existem produtos para paginar
    const produtos = document.querySelectorAll('#tabelaProdutos tbody tr');
    if (produtos.length > 0) {
        // Inicializar sistema de pagina√ß√£o
        const paginationProdutos = new TablePagination({
            tableId: 'tabelaProdutos',
            searchId: 'buscaProdutos',
            itemsPerPageId: 'itensPorPaginaProdutos',
            visibleCountId: 'itensVisiveisProdutos',
            totalCountId: 'totalItensProdutos',
            prevBtnId: 'btnAnteriorProdutos',
            nextBtnId: 'btnProximoProdutos',
            paginationControlsId: 'controlesNavegacaoProdutos',
            pageInfoId: 'infoPaginacaoProdutos',
            defaultItemsPerPage: 20,
            searchFields: ['nome', 'marca', 'categoria', 'codigo', 'status']
        });

        // Integrar com filtros existentes
        const categoriaFilter = document.getElementById('categoriaFilter');
        const statusFilter = document.getElementById('statusFilter');
        
        function aplicarFiltros() {
            const categoria = categoriaFilter.value.toLowerCase();
            const status = statusFilter.value.toLowerCase();
            
            // Reset da p√°gina para primeira
            paginationProdutos.currentPage = 1;
            
            // Filtrar linhas baseado nos crit√©rios
            paginationProdutos.allRows.forEach(row => {
                const $row = $(row);
                const categoriaTexto = $row.find('td:nth-child(5)').text().toLowerCase();
                const statusTexto = $row.find('td:nth-child(10)').text().toLowerCase();
                
                let mostrar = true;
                
                // Filtro por categoria
                if (categoria && !categoriaTexto.includes(categoria)) {
                    mostrar = false;
                }
                
                // Filtro por status
                if (status) {
                    if (status === 'disponivel' && !statusTexto.includes('dispon√≠vel')) {
                        mostrar = false;
                    } else if (status === 'estoque_baixo' && !statusTexto.includes('baixo')) {
                        mostrar = false;
                    } else if (status === 'indisponivel' && !statusTexto.includes('indispon√≠vel')) {
                        mostrar = false;
                    }
                }
                
                // Adicionar ou remover da lista filtrada
                if (mostrar) {
                    if (!paginationProdutos.filteredRows.includes(row)) {
                        paginationProdutos.filteredRows.push(row);
                    }
                } else {
                    const index = paginationProdutos.filteredRows.indexOf(row);
                    if (index > -1) {
                        paginationProdutos.filteredRows.splice(index, 1);
                    }
                }
            });
            
            paginationProdutos.updatePagination();
        }
        
        // Eventos dos filtros
        categoriaFilter.addEventListener('change', aplicarFiltros);
        statusFilter.addEventListener('change', aplicarFiltros);
        
        // Remover o event listener do searchInput antigo se existir
        const searchInputAntigo = document.getElementById('searchInput');
        if (searchInputAntigo) {
            searchInputAntigo.style.display = 'none'; // Ocultar o campo de busca antigo
        }
    }
});
</script>
{% endblock %}